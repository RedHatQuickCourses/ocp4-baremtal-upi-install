<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab (2 of 2) :: Red Hat OpenShift Container Platform 4: Baremetal UPI Installation</title>
    <link rel="prev" href="section1.html">
    <link rel="next" href="../appendix/appendix.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Red Hat OpenShift Container Platform 4: Baremetal UPI Installation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ocp4-baremtal-upi-install" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Red Hat OpenShift Container Platform 4: Baremetal UPI Installation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">UPI Baremetal Install</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section1.html">Lab (1 of 2)</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="section2.html">Lab (2 of 2)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Red Hat OpenShift Container Platform 4: Baremetal UPI Installation</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Red Hat OpenShift Container Platform 4: Baremetal UPI Installation</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Red Hat OpenShift Container Platform 4: Baremetal UPI Installation</a></li>
    <li><a href="index.html">UPI Baremetal Install</a></li>
    <li><a href="section2.html">Lab (2 of 2)</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab (2 of 2)</h1>
<div class="sect1">
<h2 id="_baremetal_upi_installation"><a class="anchor" href="#_baremetal_upi_installation"></a>Baremetal UPI Installation</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create cluster installation directory as <code>clusterconfig</code> under <code>lab-user</code> home directory on <code>provision</code> machine.</p>
</li>
<li>
<p>Run installer to create manifests.</p>
</li>
<li>
<p>Run installer to create ignition configs.</p>
</li>
<li>
<p>Copy all ign files to public html directory.</p>
</li>
<li>
<p>Rescue the nodes with uploaded image.
For this change the boot sequence by selecting the <code>toggle</code> option as shown in screenshot below.
Select the node you want to toggle:</p>
<div class="imageblock">
<div class="content">
<img src="_images/toggle.png" alt="toggle">
</div>
</div>
</li>
<li>
<p>Once you have toggled the lab, type <code>console</code> option and type the name of the node you want get console access of as shown in screenshot below:</p>
<div class="imageblock">
<div class="content">
<img src="_images/rescue.png" alt="rescue">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To boot the VM using HDD again, you will need to toggle the boot sequence again using the same <code>toggle</code> option.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Information on <code>cmd</code> script:</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Use the httpd server from provision virtual machine to host the <code>cmd</code> script.
You will need to mention the ignition-hash in the script.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">[cloud-user@provision ~]$ cat /tmp/cmd.j2
sudo nmcli con mod "Wired connection 1" ipv4.dns "192.168.3.254, 8.8.8.8"

sudo nmcli con mod "Wired connection 1" ipv4.ignore-auto-dns yes

sudo systemctl restart NetworkManager

sudo sleep 10

sudo cat /etc/resolv.conf

curl -v http://quay.io/v2

sudo coreos-installer install --ignition-url=http://192.168.3.254/~lab-user/bootstrap.ign --ignition-hash=sha512-{{bootstrap_hash.stdout}} /dev/vdb --copy-network

sudo coreos-installer install --ignition-url=http://192.168.3.254/~lab-user/master.ign --ignition-hash=sha512-{{master_hash.stdout}} /dev/vdb --copy-network

sudo coreos-installer install --ignition-url=http://192.168.3.254/~lab-user/worker.ign --ignition-hash=sha512-{{worker_hash.stdout}} /dev/vdb --copy-network</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>You will need to modify DNS setting on each node as it will automatically take the DNS server of underlying infrastructure(PSI).</p>
</li>
<li>
<p>All network connections of nodes are named with <code>Wired connection 1</code>.</p>
</li>
<li>
<p>You will notice that modifying these wired connections to connect to our DNS servers.</p>
</li>
<li>
<p>Make sure you are able to connect to <code>quay.io</code>.</p>
</li>
<li>
<p>To make this network setting persistent after reboot and successful installation of RHCOS on the nodes, you need to use <code>--copy-network</code> option in <code>coreos-installer</code> command.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Take the console of the each node, download and run the <code>cmd</code> script:</p>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">$ sh cmd</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Openstack console doesn&#8217;t have clipboard.
You can save your time of typing the command in console by modifying and downloading the CMD script using curl.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For some unidentified reason, nodes are booting with PSI DNS servers.
You will need to again update <code>/etc/resolv.conf</code> file.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Update DNS server (<code>192.168.3.254</code> and <code>8.8.8.8</code>) entries in <code>/etc/resolv.conf</code> file.
Ensure after rebooting nodes (bootstrap, masters and workers), correct DNS servers are reflected.</p>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">// ssh from provision to nodes

$ sudo sed -i "/\[main\]/a dns=none" /etc/NetworkManager/NetworkManager.conf

$ sudo cat /etc/NetworkManager/NetworkManager.conf | grep -i main -A2

$ sudo systemctl restart NetworkManager

$ sudo vi /etc/resolv.conf
nameserver 192.168.3.254
nameserver 8.8.8.8

$ sudo reboot</code></pre>
</div>
</div>
</li>
<li>
<p>After successful installation of rhcos on each node (verify from console output), unrescue the nodes using <code>toggle</code> option.</p>
</li>
<li>
<p>Take the console of each node and verify it is booted with rhcos (you should see the login prompt), in case if it is taking time or noticing internal server error then try to click on <code>Send CtrlAltDel</code> button to reboot the server.</p>
<div class="imageblock">
<div class="content">
<img src="_images/rhcos_boot.png" alt="rhcos boot">
</div>
</div>
</li>
<li>
<p>Run the <code>openshift-install</code> command to start the bootstrap process.</p>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">[lab-user@provision ~]$ openshift-install --dir clusterconfig wait-for bootstrap-complete --log-level=debug</code></pre>
</div>
</div>
</li>
<li>
<p>Update haproxy settings on load balancer (<code>lb</code>) after bootstrap process is completed.
Remove the <code>bootstrap</code> machine entry from <code>/etc/haproxy/haproxy.cfg</code> file and restart the <code>haproxy</code> service.</p>
</li>
<li>
<p>On <code>provision</code> virtual machine, export the <code>kubeconfig</code> and approve all <code>csr</code> certificates.</p>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">[lab-user@provision ~]$ export KUBECONFIG=clusterconfig/auth/kubeconfig
[lab-user@provision ~]$ oc get csr -o go-template='{{range .items}}{{if not .status}}{{.metadata.name}}{{"\n"}}{{end}}{{end}}' | xargs oc adm certificate approve</code></pre>
</div>
</div>
</li>
<li>
<p>Ensure all nodes are in ready state and all cluster operators are available.</p>
</li>
<li>
<p>Now, complete the installation by running the <code>openshift-install</code> command.</p>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">[lab-user@provision ~]$ openshift-install --dir clusterconfig/ wait-for install-complete</code></pre>
</div>
</div>
</li>
<li>
<p>After the installation completes, you can confirm that the cluster version has updated to the new version.</p>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">[lab-user@provision ~]$ oc get clusterversion
NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
version   4.18.11   True        False         2m31s   Cluster version is 4.18.11</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="section1.html">Lab (1 of 2)</a></span>
  <span class="next"><a href="../appendix/appendix.html">Appendix</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
